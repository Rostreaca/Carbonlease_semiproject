<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.board.model.dao.BoardMapper">
	
	<!-- 전체 목록 조회 -->
	<select id="findAll" resultType="BoardDTO" parameterType="map">
		SELECT 
		       ROWNUM AS boardSeq, T.*
		  FROM (
		SELECT
			   B.BOARD_NO AS boardNo,
			   B.BOARD_TITLE AS boardTitle,
			   B.BOARD_CONTENT AS boardContent,
			   B.ENROLL_DATE AS enrollDate,
			   B.VIEW_COUNT AS viewCount,
			   M.NICKNAME AS nickname,
			   COUNT(R.REPLY_NO) AS replyCount
		  FROM
		       CL_BOARD B
		  JOIN
		       CL_MEMBER M ON (B.MEMBER_NO = M.MEMBER_NO)
		  LEFT 
		  JOIN
		   	   CL_BOARD_REPLY R ON (B.BOARD_NO = R.BOARD_NO)
		 GROUP 
		    BY
			   B.BOARD_NO, B.BOARD_TITLE, B.BOARD_CONTENT, 
			   B.ENROLL_DATE, B.VIEW_COUNT, M.NICKNAME
		ORDER 
		   BY
		   	   B.BOARD_NO DESC) T
		 OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>
	
	<select id="findAndCountAll" resultType="_int">
		SELECT
				COUNT(*)
		FROM
				CL_BOARD
		WHERE
				STATUS='Y'
	</select>
	
	<!-- 게시글 상세 조회 -->
	<select id="boardDetail" parameterType="long" resultType="BoardDTO">
		 SELECT
		        B.BOARD_NO AS boardNo
		      , B.BOARD_TITLE AS boardTitle
		      , B.BOARD_CONTENT AS boardContent
		      , B.ENROLL_DATE AS enrollDate
		      , B.VIEW_COUNT AS viewCount
		      , M.NICKNAME AS nickname
		   FROM 
		   		CL_BOARD B
		   JOIN 
		   		CL_MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
		  WHERE 
		  		B.BOARD_NO = #{boardNo}
	</select>
	
	<!-- 댓글 조회 -->
	<select id="replyList" parameterType="_int" resultType="BoardReplyDTO">
		 SELECT
       		     R.REPLY_CONTENT replyContent
               , R.ENROLL_DATE enrollDate
               , B.BOARD_NO boardNo
               , R.MEMBER_NO memberNo
               , M.NICKNAME nickname
		   FROM 
		         CL_BOARD B
		   JOIN 
		         CL_BOARD_REPLY R ON B.BOARD_NO = R.BOARD_NO
		   LEFT 
		   JOIN  CL_MEMBER M ON R.MEMBER_NO = M.MEMBER_NO  
		  WHERE  B.BOARD_NO = #{boardNo}
		  ORDER 
		     BY  R.ENROLL_DATE ASC
	</select>

</mapper>